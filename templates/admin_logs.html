{% extends "admin_base.html" %}

{% block title %}{{ _('Nh·∫≠t k√Ω T·∫£i l√™n') }}{% endblock %}
{% block nav_logs %}active{% endblock %}

{% block content %}
<h3>{{ _('üìã Nh·∫≠t k√Ω t·∫£i l√™n') }}</h3>

<div class="card">
    <div class="card-header bg-info text-white">
        <h5 class="card-title mb-0">{{ _('Nh·∫≠t k√Ω t·∫£i l√™n') }}</h5>
    </div>
    <div class="card-body">
        <!-- Filter Form -->
        <form class="row g-3 mb-4">
            <div class="col-md-3">
                  <label class="form-label">{{ _('M√£ Ng√¢n h√†ng') }}</label>
                  <input type="text" name="bank_code" value="{{ request.args.get('bank_code', '') }}"
                      class="form-control" placeholder="{{ _('M√£ ng√¢n h√†ng') }}">
            </div>
            <div class="col-md-3">
                <label class="form-label" for="status-select">{{ _('Tr·∫°ng th√°i') }}</label>
                <select name="status" id="status-select" class="form-select">
                    <option value="">{{ _('T·∫•t c·∫£') }}</option>
                    <option value="SUCCESS" {% if request.args.get('status') == 'SUCCESS' %}selected{% endif %}>{{ _('Th√†nh c√¥ng') }}</option>
                    <option value="ERROR" {% if request.args.get('status') == 'ERROR' %}selected{% endif %}>{{ _('L·ªói') }}</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label" for="days-select">{{ _('Th·ªùi gian') }}</label>
                <select name="days" id="days-select" class="form-select">
                    <option value="7" {% if request.args.get('days', '7') == '7' %}selected{% endif %}>{{ _('7 ng√†y') }}</option>
                    <option value="30" {% if request.args.get('days') == '30' %}selected{% endif %}>{{ _('30 ng√†y') }}</option>
                    <option value="90" {% if request.args.get('days') == '90' %}selected{% endif %}>{{ _('90 ng√†y') }}</option>
                    <option value="0" {% if request.args.get('days') == '0' %}selected{% endif %}>{{ _('T·∫•t c·∫£') }}</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">&nbsp;</label>
                <button type="submit" class="btn btn-primary d-block">{{ _('üîç L·ªçc') }}</button>
            </div>
        </form>

        <!-- Bulk Actions -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <strong>{{ _('T·ªïng s·ªë:') }} {{ pagination.total if pagination else 0 }} {{ _('log(s)') }}</strong>
            </div>
            <div>
                <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteLogsModal"
                        {% if not pagination or pagination.total == 0 %}disabled{% endif %}>
                    {{ _('üóëÔ∏è X√≥a Nh·∫≠t k√Ω theo B·ªô l·ªçc') }}
                </button>
            </div>
        </div>

        <!-- Logs Table -->
        <div class="table-responsive">
            <table class="table table-sm table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>{{ _('Th·ªùi gian') }}</th>
                        <th>{{ _('T·ªáp g·ªëc') }}</th>
                        <th>{{ _('M√£ Ng√¢n h√†ng') }}</th>
                        <th>{{ _('Tr·∫°ng th√°i') }}</th>
                        <th>{{ _('T·ª´ kh√≥a ph√°t hi·ªán') }}</th>
                        <th>{{ _('Th√¥ng b√°o') }}</th>
                        <th>{{ _('H√†nh ƒë·ªông') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in logs %}
                    <tr>
                        <td>
                            <small>
                            {% if log.processed_at %}
                                {{ log.processed_at.strftime('%H:%M:%S %d/%m/%Y') }}
                            {% else %}
                                N/A
                            {% endif %}
                            </small>
                        </td>
                        <td>{{ log.original_filename if log.original_filename else 'N/A' }}</td>
                        <td>
                            {% if log.bank_code %}
                                <span class="badge bg-info">{{ log.bank_code }}</span>
                            {% else %}
                                <span class="badge bg-secondary">N/A</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if log.status == 'SUCCESS' %}
                                <span class="badge bg-success">{{ _('Th√†nh c√¥ng') }}</span>
                            {% elif log.status == 'ERROR' %}
                                <span class="badge bg-danger">{{ _('L·ªói') }}</span>
                            {% else %}
                                <span class="badge bg-warning text-dark">{{ log.status }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if log.detected_keywords %}
                                {% for keyword in log.detected_keywords %}
                                    <span class="badge bg-info me-1">{{ keyword }}</span>
                                {% endfor %}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td><small>{{ log.message }}</small></td>
                        <td>
                            {% if log.filename %}
                            <a class="btn btn-sm btn-outline-primary" href="{{ url_for('main.download_bank_log_file', log_id=log.id) }}" title="{{ _('T·∫£i T·ªáp g·ªëc') }}">
                                {{ _('üì• T·∫£i T·ªáp') }}
                            </a>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center text-muted">{{ _('Kh√¥ng t√¨m th·∫•y nh·∫≠t k√Ω n√†o') }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    {% if pagination and pagination.total > 0 %}
    <div class="card-footer d-flex justify-content-between align-items-center">
        <div>
            {{ _('Hi·ªÉn th·ªã') }} {{ ((pagination.page - 1) * pagination.per_page) + 1 }} - {{ [pagination.page * pagination.per_page, pagination.total]|min }} / {{ pagination.total }} {{ _('m·ª•c') }}
        </div>
        <div class="btn-group">
            {% if pagination.has_prev %}
                <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('upload.view_logs', page=pagination.page - 1, per_page=pagination.per_page, bank_code=request.args.get('bank_code', ''), status=request.args.get('status', ''), days=request.args.get('days', '7')) }}">{{ _('¬´ Tr∆∞·ªõc') }}</a>
            {% else %}
                <a class="btn btn-sm btn-outline-secondary disabled">{{ _('¬´ Tr∆∞·ªõc') }}</a>
            {% endif %}
            <span class="btn btn-sm btn-outline-secondary disabled">{{ _('Trang') }} {{ pagination.page }}/{{ pagination.total_pages }}</span>
            {% if pagination.has_next %}
                <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('upload.view_logs', page=pagination.page + 1, per_page=pagination.per_page, bank_code=request.args.get('bank_code', ''), status=request.args.get('status', ''), days=request.args.get('days', '7')) }}">{{ _('Sau ¬ª') }}</a>
            {% else %}
                <a class="btn btn-sm btn-outline-secondary disabled">{{ _('Sau ¬ª') }}</a>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Delete Logs Modal -->
<div class="modal fade" id="deleteLogsModal" tabindex="-1" aria-labelledby="deleteLogsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteLogsModalLabel">{{ _('üóëÔ∏è X√≥a nh·∫≠t k√Ω') }}</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <strong>{{ _('‚ö†Ô∏è C·∫£nh b√°o:') }}</strong> {{ _('B·∫°n ƒëang x√≥a nh·∫≠t k√Ω theo b·ªô l·ªçc hi·ªán t·∫°i:') }}
                </div>

                <ul class="list-unstyled">
                    <li><strong>{{ _('M√£ Ng√¢n h√†ng:') }}</strong>
                        <span class="badge bg-info">{{ request.args.get('bank_code') if request.args.get('bank_code') else _('T·∫•t c·∫£') }}</span>
                    </li>
                    <li><strong>{{ _('Tr·∫°ng th√°i:') }}</strong>
                        <span class="badge bg-info">
                            {% if request.args.get('status') == 'SUCCESS' %}{{ _('Th√†nh c√¥ng') }}
                            {% elif request.args.get('status') == 'ERROR' %}{{ _('L·ªói') }}
                            {% else %}{{ _('T·∫•t c·∫£') }}{% endif %}
                        </span>
                    </li>
                    <li><strong>{{ _('Th·ªùi gian:') }}</strong>
                        <span class="badge bg-info">
                            {% if request.args.get('days') == '30' %}{{ _('30 ng√†y') }}
                            {% elif request.args.get('days') == '90' %}{{ _('90 ng√†y') }}
                            {% elif request.args.get('days') == '0' %}{{ _('T·∫•t c·∫£') }}
                            {% else %}{{ _('7 ng√†y') }}{% endif %}
                        </span>
                    </li>
                    <li><strong>{{ _('S·ªë l∆∞·ª£ng s·∫Ω x√≥a:') }}</strong>
                        <span class="badge bg-danger text-white">{{ pagination.total if pagination else 0 }} {{ _('log(s)') }}</span>
                    </li>
                </ul>

                <hr>
                <p class="text-danger mb-0">
                    <strong>{{ _('H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!') }}</strong> {{ _('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a?') }}
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('‚ùå H·ªßy') }}</button>
                <form method="POST" action="{{ url_for('upload.delete_logs') }}" class="d-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="bank_code" value="{{ request.args.get('bank_code', '') }}">
                    <input type="hidden" name="status" value="{{ request.args.get('status', '') }}">
                    <input type="hidden" name="days" value="{{ request.args.get('days', '7') }}">
                    <button type="submit" class="btn btn-danger">{{ _('üóëÔ∏è X√°c nh·∫≠n x√≥a') }}</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

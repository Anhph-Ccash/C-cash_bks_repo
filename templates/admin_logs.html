{% extends "admin_base.html" %}

{% block title %}{{ _('Nh·∫≠t k√Ω T·∫£i l√™n') }}{% endblock %}
{% block nav_logs %}active{% endblock %}

{% block content %}
<h3>{{ _('üìã Nh·∫≠t k√Ω t·∫£i l√™n') }}</h3>

<div class="card">
    <div class="card-header bg-info text-white">
        <h5 class="card-title mb-0">{{ _('Nh·∫≠t k√Ω t·∫£i l√™n') }}</h5>
    </div>
    <div class="card-body">
        <!-- Filter Form -->
        <form class="row g-3 mb-4">
            <div class="col-md-3">
                  <label class="form-label">{{ _('M√£ Ng√¢n h√†ng') }}</label>
                  <input type="text" name="bank_code" value="{{ request.args.get('bank_code', '') }}"
                      class="form-control" placeholder="{{ _('M√£ ng√¢n h√†ng') }}">
            </div>
            <div class="col-md-3">
                <label class="form-label" for="status-select">{{ _('Tr·∫°ng th√°i') }}</label>
                <select name="status" id="status-select" class="form-select">
                    <option value="">{{ _('T·∫•t c·∫£') }}</option>
                    <option value="SUCCESS" {% if request.args.get('status') == 'SUCCESS' %}selected{% endif %}>{{ _('Th√†nh c√¥ng') }}</option>
                    <option value="ERROR" {% if request.args.get('status') == 'ERROR' %}selected{% endif %}>{{ _('L·ªói') }}</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label" for="days-select">{{ _('Th·ªùi gian') }}</label>
                <select name="days" id="days-select" class="form-select">
                    <option value="7" {% if request.args.get('days', '7') == '7' %}selected{% endif %}>{{ _('7 ng√†y') }}</option>
                    <option value="30" {% if request.args.get('days') == '30' %}selected{% endif %}>{{ _('30 ng√†y') }}</option>
                    <option value="90" {% if request.args.get('days') == '90' %}selected{% endif %}>{{ _('90 ng√†y') }}</option>
                    <option value="0" {% if request.args.get('days') == '0' %}selected{% endif %}>{{ _('T·∫•t c·∫£') }}</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">&nbsp;</label>
                <button type="submit" class="btn btn-primary d-block">{{ _('üîç L·ªçc') }}</button>
            </div>
        </form>

        <!-- Bulk Actions -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <strong>{{ _('T·ªïng s·ªë:') }} {{ pagination.total if pagination else 0 }} {{ _('log(s)') }}</strong>
                <span class="ms-3">
                    <small class="text-muted">{{ _('ƒê√£ ch·ªçn:') }} <span id="selectedCount">0</span></small>
                </span>
            </div>
            <div>
                <button type="button" class="btn btn-warning btn-sm me-2" id="selectAllBtn" style="display:none;">
                    {{ _('‚úì Ch·ªçn t·∫•t c·∫£') }}
                </button>
                <button type="button" class="btn btn-secondary btn-sm me-2" id="deselectAllBtn" style="display:none;">
                    {{ _('‚úó B·ªè ch·ªçn t·∫•t c·∫£') }}
                </button>
                <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteLogsModal"
                        id="deleteSelectedBtn" style="display:none;">
                    {{ _('üóëÔ∏è X√≥a m·ª•c ƒë√£ ch·ªçn') }}
                </button>
                <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteLogsModal"
                        id="deleteAllBtn" disabled>
                    {{ _('üóëÔ∏è X√≥a nh·∫≠t k√Ω t·∫£i l√™n') }}
                </button>
            </div>
        </div>

        <!-- Logs Table -->
        <div class="table-responsive">
            <table class="table table-sm table-hover mb-0" id="logsTable">
                <thead class="table-light">
                    <tr>
                        <th>
                            <input type="checkbox" id="selectAllCheckbox" class="form-check-input" title="{{ _('Ch·ªçn t·∫•t c·∫£ tr√™n trang n√†y') }}">
                        </th>
                        <th>{{ _('Th·ªùi gian') }}</th>
                        <th>{{ _('T·ªáp g·ªëc') }}</th>
                        <th>{{ _('M√£ Ng√¢n h√†ng') }}</th>
                        <th>{{ _('Tr·∫°ng th√°i') }}</th>
                        <th>{{ _('T·ª´ kh√≥a ph√°t hi·ªán') }}</th>
                        <th>{{ _('Th√¥ng b√°o') }}</th>
                        <th>{{ _('H√†nh ƒë·ªông') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in logs %}
                    <tr>
                        <td>
                            <input type="checkbox" class="form-check-input log-checkbox" value="{{ log.id }}" data-log-id="{{ log.id }}" title="{{ _('Ch·ªçn nh·∫≠t k√Ω n√†y') }}">
                        </td>
                        <td>
                            <small>
                            {% if log.processed_at %}
                                {{ log.processed_at.strftime('%H:%M:%S %d/%m/%Y') }}
                            {% else %}
                                N/A
                            {% endif %}
                            </small>
                        </td>
                        <td>{{ log.original_filename if log.original_filename else 'N/A' }}</td>
                        <td>
                            {% if log.bank_code %}
                                <span class="badge bg-info">{{ log.bank_code }}</span>
                            {% else %}
                                <span class="badge bg-secondary">N/A</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if log.status == 'SUCCESS' %}
                                <span class="badge bg-success">{{ _('Th√†nh c√¥ng') }}</span>
                            {% elif log.status == 'ERROR' %}
                                <span class="badge bg-danger">{{ _('L·ªói') }}</span>
                            {% else %}
                                <span class="badge bg-warning text-dark">{{ log.status }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if log.detected_keywords %}
                                {% for keyword in log.detected_keywords %}
                                    <span class="badge bg-info me-1">{{ keyword }}</span>
                                {% endfor %}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td><small>{{ log.message }}</small></td>
                        <td>
                            <div class="d-flex gap-1">
                                {% if log.filename %}
                                <a class="btn btn-sm btn-outline-primary" href="{{ url_for('main.download_bank_log_file', log_id=log.id) }}" title="{{ _('T·∫£i T·ªáp g·ªëc') }}">
                                    {{ _('üì• T·∫£i') }}
                                </a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="8" class="text-center text-muted">{{ _('Kh√¥ng t√¨m th·∫•y nh·∫≠t k√Ω n√†o') }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    {% if pagination and pagination.total > 0 %}
    <div class="card-footer d-flex justify-content-between align-items-center">
        <div>
            {{ _('Hi·ªÉn th·ªã') }} {{ ((pagination.page - 1) * pagination.per_page) + 1 }} - {{ [pagination.page * pagination.per_page, pagination.total]|min }} / {{ pagination.total }} {{ _('m·ª•c') }}
        </div>
        <div class="btn-group">
            {% if pagination.has_prev %}
                <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('upload.view_logs', page=pagination.page - 1, per_page=pagination.per_page, bank_code=request.args.get('bank_code', ''), status=request.args.get('status', ''), days=request.args.get('days', '7')) }}">{{ _('¬´ Tr∆∞·ªõc') }}</a>
            {% else %}
                <a class="btn btn-sm btn-outline-secondary disabled">{{ _('¬´ Tr∆∞·ªõc') }}</a>
            {% endif %}
            <span class="btn btn-sm btn-outline-secondary disabled">{{ _('Trang') }} {{ pagination.page }}/{{ pagination.total_pages }}</span>
            {% if pagination.has_next %}
                <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('upload.view_logs', page=pagination.page + 1, per_page=pagination.per_page, bank_code=request.args.get('bank_code', ''), status=request.args.get('status', ''), days=request.args.get('days', '7')) }}">{{ _('Sau ¬ª') }}</a>
            {% else %}
                <a class="btn btn-sm btn-outline-secondary disabled">{{ _('Sau ¬ª') }}</a>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Delete Logs Modal -->
<div class="modal fade" id="deleteLogsModal" tabindex="-1" aria-labelledby="deleteLogsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteLogsModalLabel">{{ _('üóëÔ∏è X√≥a nh·∫≠t k√Ω') }}</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <strong>{{ _('‚ö†Ô∏è C·∫£nh b√°o:') }}</strong>
                    <span id="deleteWarningText"></span>
                </div>

                <div id="filterDeleteInfo" class="mb-3">
                    <ul class="list-unstyled">
                        <li><strong>{{ _('M√£ Ng√¢n h√†ng:') }}</strong>
                            <span class="badge bg-info">{{ request.args.get('bank_code') if request.args.get('bank_code') else _('T·∫•t c·∫£') }}</span>
                        </li>
                        <li><strong>{{ _('Tr·∫°ng th√°i:') }}</strong>
                            <span class="badge bg-info">
                                {% if request.args.get('status') == 'SUCCESS' %}{{ _('Th√†nh c√¥ng') }}
                                {% elif request.args.get('status') == 'ERROR' %}{{ _('L·ªói') }}
                                {% else %}{{ _('T·∫•t c·∫£') }}{% endif %}
                            </span>
                        </li>
                        <li><strong>{{ _('Th·ªùi gian:') }}</strong>
                            <span class="badge bg-info">
                                {% if request.args.get('days') == '30' %}{{ _('30 ng√†y') }}
                                {% elif request.args.get('days') == '90' %}{{ _('90 ng√†y') }}
                                {% elif request.args.get('days') == '0' %}{{ _('T·∫•t c·∫£') }}
                                {% else %}{{ _('7 ng√†y') }}{% endif %}
                            </span>
                        </li>
                        <li><strong>{{ _('S·ªë l∆∞·ª£ng s·∫Ω x√≥a:') }}</strong>
                            <span class="badge bg-danger text-white">{{ pagination.total if pagination else 0 }} {{ _('log(s)') }}</span>
                        </li>
                    </ul>
                </div>

                <div id="selectedItemsInfo" class="mb-3">
                    <strong>{{ _('C√°c nh·∫≠t k√Ω ƒë√£ ch·ªçn:') }}</strong>
                    <ul class="list-unstyled" id="selectedLogsList"></ul>
                    <p class="text-muted small">{{ _('S·ªë l∆∞·ª£ng s·∫Ω x√≥a:') }} <span id="selectedLogsCount" class="badge bg-danger text-white">0</span></p>
                </div>

                <hr>
                <p class="text-danger mb-0">
                    <strong>{{ _('H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!') }}</strong> {{ _('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a?') }}
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('‚ùå H·ªßy') }}</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">{{ _('üóëÔ∏è X√°c nh·∫≠n x√≥a') }}</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const logCheckboxes = document.querySelectorAll('.log-checkbox');
    const selectedCount = document.getElementById('selectedCount');
    const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
    const deselectAllBtn = document.getElementById('deselectAllBtn');
    const selectAllBtn = document.getElementById('selectAllBtn');
    const deleteAllBtn = document.getElementById('deleteAllBtn');

    // Handle individual checkbox changes
    logCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectionUI);
    });

    // Handle select all checkbox
    selectAllCheckbox.addEventListener('change', function() {
        logCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        updateSelectionUI();
    });

    // Handle select all button
    selectAllBtn.addEventListener('click', function() {
        logCheckboxes.forEach(checkbox => {
            checkbox.checked = true;
        });
        selectAllCheckbox.checked = true;
        updateSelectionUI();
    });

    // Handle deselect all button
    deselectAllBtn.addEventListener('click', function() {
        logCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        selectAllCheckbox.checked = false;
        updateSelectionUI();
    });

    function updateSelectionUI() {
        const selectedCheckboxes = document.querySelectorAll('.log-checkbox:checked');
        const count = selectedCheckboxes.length;
        selectedCount.textContent = count;

        // Update button visibility and state
        if (count > 0) {
            // Show select/deselect buttons when checkboxes selected
            selectAllBtn.classList.remove('d-none');
            deselectAllBtn.classList.remove('d-none');
            // Hide individual delete selected button - use main button instead
            deleteSelectedBtn.classList.add('d-none');
            // Enable delete button when checkboxes are selected
            deleteAllBtn.disabled = false;
        } else {
            // Hide select/deselect buttons when no checkboxes selected
            selectAllBtn.classList.add('d-none');
            deselectAllBtn.classList.add('d-none');
            deleteSelectedBtn.classList.add('d-none');
            // Disable delete button when no checkboxes are selected
            deleteAllBtn.disabled = true;
        }
    }

    // Handle delete selected button click
    deleteSelectedBtn.addEventListener('click', function(e) {
        e.preventDefault();
        const selectedCheckboxes = document.querySelectorAll('.log-checkbox:checked');
        const logIds = Array.from(selectedCheckboxes).map(cb => cb.value);

        // Update modal content for selected items
        const filterDeleteInfo = document.getElementById('filterDeleteInfo');
        const selectedItemsInfo = document.getElementById('selectedItemsInfo');
        const deleteWarningText = document.getElementById('deleteWarningText');
        const selectedLogsList = document.getElementById('selectedLogsList');
        const selectedLogsCount = document.getElementById('selectedLogsCount');

        filterDeleteInfo.style.display = 'none';
        selectedItemsInfo.style.display = 'block';

        deleteWarningText.textContent = '{{ _('B·∫°n ƒëang x√≥a c√°c nh·∫≠t k√Ω ƒë∆∞·ª£c ch·ªçn:') }}';

        // Build list of selected items
        selectedLogsList.innerHTML = '';
        selectedCheckboxes.forEach(checkbox => {
            const row = checkbox.closest('tr');
            const filename = row.cells[2].textContent.trim();
            const timestamp = row.cells[1].textContent.trim();
            const li = document.createElement('li');
            li.innerHTML = `<small>${filename} (${timestamp})</small>`;
            selectedLogsList.appendChild(li);
        });

        selectedLogsCount.textContent = logIds.length;

        // Set form fields
        document.getElementById('deleteType').value = 'selected';
        document.getElementById('selectedLogIds').value = JSON.stringify(logIds);
        document.getElementById('deleteForm').action = '{{ url_for('upload.delete_logs_selected') }}';
    });

    // Handle delete all button click
    deleteAllBtn.addEventListener('click', function(e) {
        e.preventDefault();

        const selectedCheckboxes = document.querySelectorAll('.log-checkbox:checked');
        const filterDeleteInfo = document.getElementById('filterDeleteInfo');
        const selectedItemsInfo = document.getElementById('selectedItemsInfo');
        const deleteWarningText = document.getElementById('deleteWarningText');

        // Store delete info for later use in confirm button
        window.deleteInfo = {
            selectedCount: selectedCheckboxes.length,
            selectedLogIds: Array.from(selectedCheckboxes).map(cb => cb.value),
            isFilter: selectedCheckboxes.length === 0
        };

        // If checkboxes selected: delete selected items only
        if (selectedCheckboxes.length > 0) {
            filterDeleteInfo.style.display = 'none';
            selectedItemsInfo.style.display = 'block';

            deleteWarningText.textContent = '{{ _('B·∫°n ƒëang x√≥a c√°c nh·∫≠t k√Ω ƒë∆∞·ª£c ch·ªçn:') }}';

            // Build list of selected items
            const selectedLogsList = document.getElementById('selectedLogsList');
            const selectedLogsCount = document.getElementById('selectedLogsCount');
            selectedLogsList.innerHTML = '';
            selectedCheckboxes.forEach(checkbox => {
                const row = checkbox.closest('tr');
                const filename = row.cells[2].textContent.trim();
                const timestamp = row.cells[1].textContent.trim();
                const li = document.createElement('li');
                li.innerHTML = `<small>${filename} (${timestamp})</small>`;
                selectedLogsList.appendChild(li);
            });

            selectedLogsCount.textContent = selectedCheckboxes.length;
        }
        // If no checkboxes selected: delete by filter
        else {
            filterDeleteInfo.style.display = 'block';
            selectedItemsInfo.style.display = 'none';

            deleteWarningText.textContent = '{{ _('B·∫°n ƒëang x√≥a nh·∫≠t k√Ω theo b·ªô l·ªçc hi·ªán t·∫°i:') }}';
        }
    });

    // Handle confirm delete button click
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    if (confirmDeleteBtn) {
        confirmDeleteBtn.addEventListener('click', function(e) {
            e.preventDefault();

            if (!window.deleteInfo) return;

            const deleteInfo = window.deleteInfo;
            const url = deleteInfo.isFilter ? '{{ url_for("upload.delete_logs") }}' : '{{ url_for("upload.delete_logs_selected") }}';

            const formData = new FormData();
            formData.append('csrf_token', '{{ csrf_token() }}');
            formData.append('delete_type', deleteInfo.isFilter ? 'filter' : 'selected');

            if (deleteInfo.isFilter) {
                formData.append('bank_code', '{{ request.args.get("bank_code", "") }}');
                formData.append('status', '{{ request.args.get("status", "") }}');
                formData.append('days', '{{ request.args.get("days", "7") }}');
            } else {
                formData.append('log_ids', JSON.stringify(deleteInfo.selectedLogIds));
            }

            // Disable button and show loading
            confirmDeleteBtn.disabled = true;
            const originalText = confirmDeleteBtn.textContent;
            confirmDeleteBtn.textContent = '{{ _("ƒêang x√≥a...") }}';

            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token() }}'
                }
            })
            .then(response => {
                if (response.ok) {
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('deleteLogsModal'));
                    if (modal) modal.hide();

                    // Show success message
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show';
                    alertDiv.setAttribute('role', 'alert');
                    alertDiv.innerHTML = `
                        ‚úÖ {{ _('ƒê√£ x√≥a th√†nh c√¥ng!') }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    `;
                    document.querySelector('.card-body').insertBefore(alertDiv, document.querySelector('.card-body').firstChild);

                    // Reload table after short delay
                    setTimeout(() => location.reload(), 1000);
                } else {
                    alert('{{ _("L·ªói khi x√≥a!") }}');
                    confirmDeleteBtn.disabled = false;
                    confirmDeleteBtn.textContent = originalText;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('{{ _("L·ªói khi x√≥a!") }}');
                confirmDeleteBtn.disabled = false;
                confirmDeleteBtn.textContent = originalText;
            });
        });
    }
});
</script>

{% endblock %}
